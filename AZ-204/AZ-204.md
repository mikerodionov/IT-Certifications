# Exam AZ-204: Developing Solutions for Microsoft Azure

5 OD

| OD                                                             | Percentage |
|----------------------------------------------------------------|------------|
| Develop Azure compute solutions                                | 25-30%     |
| Develop for Azure storage                                      | 15-20%     |
| Implement Azure security                                       | 20-25%     |
| Monitor, troubleshoot, and optimize Azure solutions            | 15-20%     |
| Connect to and consume Azure services and third-party services | 15-20%     |

Exam is focused on designing, building, testing and maintaining Azure solutions

## Develop Azure compute solutions - 25-30%

Various options of hosting of your workloads in the cloud.

### Azure Compute Solutions

#### Choosing Services - Decision Factors

- Price
- Scalability
- Reliability
- Infrastructure responsibility level (from IaaS to Serverless)

#### IaaS - Infrastructure as a Service

**Infrastructure as a Service (IaaS)** allows you to provision, manage, and use cloud-based infrastructure.
    - HW is managed for you, you manage infra (VMs and so on)
    - Pay for run time - idle run included

- **VMs** - classic IaaS solution  (compute resource)
    - Provisioning options
        - Hardware
        - Size - HW specs/price
        - Communication
        - Resiliency - no redundancy, AZ, Availability Set
        - Image = OS
        - Disks
            - Managed (recommended) - underlying storage, availability, security and scaling - ALL IS MANAGED FOR YOU
            - Unmanaged - EVERYTHING IS MANAGED BY YOU
        - Configuration for remote access
    - Provisioning from portal/from CLI
- **Azure Container Services** - except of AKS (not in scope for AZ-204, was in scope for retired exam AZ-203)
    - **Docker** - to create container images which then used to create container instance(s)
    - **Azure Contianer Registry (ACR)** - private registry for storage and management of the images
    - **Azure Container Instance (ACI)** -simplest way to run an image without any infra management
    - With the help of the above 3 tools we can work with containers and images:
            - Create
            - Store
            - Manage
            - Deploy
            - Run

#### PaaS

- **Azure App Service** - a fully managed platform for building, deploying, and scaling your **web apps**. Web apps hosting option (similar to AWS Elastic Beanstalk) & one of the oldest/longest supported Azure services which serves over 40 billion requests every day
    - Create/monitor/manage
        - Publish - Code/Docker container
        - Publish stack
        - Runtime stack - Linux/Windows
    - Deployment - Linux/Windows/Bring Your Own Code/Containers
    - Scaling
        - App service plan - determines location, features, cost and compute resources available to your app
            - SKU (Free, Shared, Basic, Standard, Premium, Isolated) & size
                - SKU 
                    - Free - try for free
                    - Shared - shared env for dev/test
                    - Basic - dedicated env for dev/test
                    - Standard - env for production workloads
                    - Premium - enchanced performance and scale
                    - Isolated - high-perfromance, security & isolation
    - App insights - for logging and monitoring

**KNOW FOR EXAM**:
- New web app set up
- How to setup a new job inside a web app (with C# SDK)
- Monitoring using app inights
- Application settings
- Setting up new WebJobs
- Deploying code
- Autoscaling rules implementation (on schedule or triggered by metrics)

#### Serverless - host your workloads without managing any servers or infra, you only define work/provide code

- Pay for compute time - only code execution time = lower costs if compared with IaaS/PaaS
- No infrastructure management
- Focus on workload design

- **Azure Functions** - an event-based offering for carrying out serverless computations (main Azure serverless option)
    - Event based solution with a range of triggers
    - Implementation
    - Triggers
        - Timers
        - Data Operations (something added to a Storage Queue or Blob Storage)
        - Webhooks
       ```C#
       // Function trigger example with schedule set to every 5 minutes
       [FunctionName("TimetTriggerExample")]
       public static void Run(
            // Schedule syntax: Second-Minute-Hour-Day-Month-Day of the Week - 6 values
            [TimerTrigger("O */5 * * * *")]TimerInfo myTimer,
            ILogger log)
       {
            log.LogInformation($"Timer trigger function executed at: {DateTime.Now}");
       }
       ```
    - Input and Output Bindings - to connect function with other services (storage blobs, CosmosDB, Event Grid, etc.) - blob and queue storage are most frequently used
      ```C#
      // Function binding example
      [FunctionName("BindingExample")]
      [return: Queue("queueOutput")]
      public static void Run(
        [TimerTrigger("0 */5 * * * *")]TimerInfo myTimer,
        [Blob("data", FileAccess.Read)] Stream input,
        ILogger log)
      {
        log.LogInormation($"C# Timer trigger function executed at: {DateTime.Now}");
        using StreamReader reader = new StreamReader(input);
        return reader.ReadToEnd();
       }
      ```
    - Durable functions - used for long-running stateful orchestration of async operations
        - From durable function we call asynchronous activity functions

## Develop for Azure storage - 15-20%

Where to store inputs/outputs for workloads you support/run. Deciding factors:
- Price
- Scalability
- Reliability
- Query type (streaming, analytics)
- Data type (structured, unstructured)

AZ-204 scope includes Cosmos DB and Azure Blob storage types.

### Cosmos DB

**Cosmos DB** - fully-managed NoSQL data storage solution.

- NoSQL = Not-Only SQL
    - type of databases which are used for storing nonrelational data (flexibal schima and other than tabular data store format)
    - high throughput (as there is no/or lesser need for engine to apply locks to ensure consistency)
- CosmosDB pros
    - low latency
    - high throughput
    - global consistency
- CosmosDB cons
    - Cost - very high for high volumes of data, partially alleviated by Serverless pricing (not in scope for AZ-204)

- Cosmos DB account includes **3 levels** (creation order):
    - Databases (multiple per account, top level management point for containers/collection of containers)
    - Containers (multiple per database, collection of items) - partitioning and scaling are implemented on this level
    - Items (actual data/documents stored within containers)

- Partitioning implemented on container level
    - Identify values to be used as **unique IDs**
    - Identify **partition key** candidates based on scenario

- APIs
    - Core (SQL) API - query documents using SQL-like syntax
    - Gremlin (Graph) API - for interconnected documents with a graph-like structure
    - Storage-like APIs
        - MongoDB
        - Cassandra
        - Table storage
    - Exam required knowledge:
        - Choose the correct API
        - Interact with data using the SDK

- Server-Side Operations
    - Stored procedures
    - Triggers
    - Change feed notifications (full log of changes within DB)

- Consistently levels
    - Strong - reads guaranteed to return the most recent version
    - Bounded staleness - reads may lag behind by defined number of versions
    - Session - reads guaranteed to be consistent within a client session
    - Consistent prefix - 
    - Eventual - no guarantee for reads
- Define consistency baseed on requirements
    - Everyone sees the same data at all times = STRONG consistency
    - Eventually everyone sees the same data / lowest costs = EVENTUAL consistency
- Querying (using stored procedures, triggers and change feed notifications)
- Data stored as binary BLOBs and can be organized into containers (but it is stored in a flat structure)
- Use cases: static contents, content delivery, logs, back ups
 
    
### Azure Blob Storage

- Part of Azure Storage offering (Table, Blob, Queue, Files, Disks)
- Storage optimized for storing large amounts of unstructured data
- Cost effective
- Large data volumes
- Store unstructured data

- Limits - see [Scalability and performance targets for standard storage accounts](https://docs.microsoft.com/en-us/azure/storage/common/scalability-targets-standard-account)
    - Default maximum storage account capacity - 5 PiB (1,024 TiB)

```
A pebibyte (PiB) is a unit of measure used to describe data capacity. The prefix pebi was created as part of the binary system for measuring computing and storage capacity, which is based on powers of two. One pebibyte equals 250 or 1,125,899,906,842,624 bytes.
```
- Blobs organized into containers
- Within containers blobs are stored in a flat structure, but folder structure can be imitated via file names ("structured blob name", e.g. "/data/report/file.txt")

#### Required knowledge:

- Data management - move items between storage accounts and containers
- Data access - access and manipulate blob items
- SDKs
- Retention and data lifecycle / archiving options
- Use of Storage Explorer, Azure CLI, Azure Portal for all of the above

#### Metafata

Metadata is key-value pairs to store important information about the data
    - Content type
    - Language
    - Other

#### Using the .NET SDK to maniuplate storage data

- Read/write/update metadata

#### Azure Blob Storage data lifecycle

Lifecicle Management used to manage data lifecycle:

Creation > Frequent Access > Infrequent Access > Archiving/deletion

- Hot Access
    - Optimized for frequent access
    - More expensive
- Cool Access
    - Optimized for less frequent access
    - Data that stored for at least 30 days
    - Cheaper
- Archive
    - Data no longer needs to be accessed
    - Set retention policies based on time


AZ-203 used to include table storage & relational database but they are not included in AZ-204. 

## Implement Azure security - 20-25%

4 Azure security feature groups:

- **Transparency** - a high degree of transparency on how data is managed and secured so that you can be confident that your data is protected
- **Compliance** - many offerings in Azure helping you meet compliance and regulatory requirements
- **Data Access** - might need to be controlled by region, regulations, or withing security groups or time constraints
- **Monitoring** - Azure services provide many monitoring & alerting options

AZ 204 exam security OD includes only 2 topics:
- Authentication and authorization
- Access Azure Resources

### Authentication and authorization

- Authentication - validating user's identities
- Authorization - giving access to those identities (validating identity permissions for specific operation)

### Azure AD (AAD)

- AAD handles both authentication and authorization
- Security principals (people and applications identies)
    - User principals
    - Service principals
    - Managed identities (tie security principal to app, removing need for storing and managing credentials)

- Azure Key Vault - secrets storage which can store
    - Keys
    - Secrets
    - Certificates

#### Open Authorization Framework (OAuth)

- Openly available authorization pattern

- **Traditional authorization** - restriction and access revokation difficulties
    - User credentials - username and password
- **OAuth2**
    - Provide an access token which contains
        - Scope
        - Lifetime
    - Acquire tokens using the MSFT Identity platform using
        - .NET SDK
        - Azure CLI
    
#### Shared Access Signature (SAS) tokens

- Provide delegated access to resources (usually storage accounts)
- Used instead of providing direct access to storage account
- Access options
    - Connection string
        - Unrestricted access
        - Revoked by invalidating key
    - SAS token
        - Define operations
        - Provide scope
        - Provide time limit

#### Azure Active Directory (AAD) ####

- Azure framework for authentication and authorization
- User authentication
    - Register AAD application
    - Add users
- **RBAC**
    - Assign users or applications a role
    - Access rules defined by role assigned to user/application
    - Azure predifined RBAC roles
        - Owner - full access and permission management
        - Read and write access, no permissions management
        - Reader - read-only access
    - RBAC roles can be applied on different levels
        - Resource
        - Resource Group
        - Subscription
    - Service specific RBAC roles
        - Data blob contributor
        - etc.
    - Custom RBAC roles
        - Define your own access rulesets
    - Create and assign access roles using
        - Azure Portal
        - Azure CLI

#### Access Azure Resources
    - Azure App Configuration
    - Azure Key Vault
    - Managed Identities

### Implement secure Azure Solutions

#### Azure Key Vault

- Secure keys, certificates, and secrets - centralized store and usage monitoring
    - Keys - generate or bring your own
        - Type - RSA / EC
        - RSA Key Size - 2048, 3072, 4069
        - Activation/Expirtation date
    - Secrets
        - Any values that needs to be stored securely (passwords, connectino strings) - values are versioned with previous versions visible
    - Certificates (TLS/SSL)
- Storing app config using API
- Using CLI and .NET SDK, manage:
    - Keys
    - Secrets
    - Certificates
- How to create and set KV secrets using KV URI & .NET SDK
- Azure app configuration - centralizing and managing app settings
- Managed identities - to remove the need to store secrets

- Identities
    - Service principals
        - Provide identities to applications
        - Store credentials
    - Managed identities
        - Provide identities to applications
        - Linked to applications
        - No credential management
        - Use to access - Azure Functions, VMs, Azure App Service 

## Monitor, troubleshoot, and optimize Azure solutions - 15-20%

### Content Delivery and caching

- Caching - storing local copy of data so it doesn't need to be re-retrieved from the server/remote location each time it's accessed.
- Implementing a content delivery network
- Caching policies
- Redis cache


#### Content delivery networks (CDN)

- CDN - efficiently delivers web content to users via caching; improves performance through content delivery through serversh which are physically closer to consumers (point of presence locations)
- CDN profiles & CDN endpoints
    - Origin type
        - Storage
        - Storage static website
        - Cloud service
        - Web app
        - Custom origin

#### Azure Front Door caching and expiration policies

- Azure Front Door - CDN implementation which provides a secure single single point of entry to applications, APIs & content
    - Control web traffic
    - Monitor traffic
    - Implement caching policies (caching headers & rules)

#### Azure Cache for Redis

- In-memory content store/cache
- Connect to Azure Cache for Redis

```C#
# Connecting to Azure Cache for Redis
string cacheConnection = ConfigurationManager.AppSettings["CacheConnection"].ToString();
return ConnectionMultiplexer.Connect(cacheConnection);
```
```C#
# Set and retrieve data from Redis Cache
IDatabase cache = Connection.GetDatabase();
cache.StringSet("Value1", "A value");
string value1 = cache.StringGet("Value1")
Console.Writeline(value1);
```

### Monitoring Azure Resources

Goal of monitoring is diagnosting faults and maximizing service up-time.

- Configure application insights
- Implement web test and alerts
- Use Azure Monitor to analyze and diagnose failures
- Protect against transient failures (writing code which handles those)

#### Application Insights

- Service for monitoring Azure services, part of Azure Monitor (which in turn provides specific logging solutions for Azure Storage, Cosmos DB, VMs, and containers)
    - Logs
    - Metrics
- We provide service with Application Insights Instrumentation Key & configure it to send logging to App Insights instance
- Once configured Application Insights instance allows to visualise/analyze collected metrics & alerts or use transaction search
- We can set alerts based on
    - metrics (error or data volume growth, CPU usage growth etc.)
    - failures
    - custom logs

#### Azure Monitor

- Provides specific logging solutions for Azure Storage, Cosmos DB, VMs, and containers
    - Tracking
    - Troubleshooting
- Dasboards and workbooks can be used to create visualisations based on log data
- Smart alerts can be set up to dynamically monitor for anomalies and failures
- Azure Logic Apps have alert integration & allow to send email or SMS based on alert
- Azure Monitor Logging Query

```KQL
requests
| where resultCode == "500"
```
- **Azure Log Analytics** - used to view, query, and analyze logs from Azure Monitor

#### Transient failure (handling with defensive code)

- A **transient failure** is an error caused by **temporarily** unavailable/failing service
- Often such errors are handled by SDKs and tools but sometimes you need to write your code to handle them too
- Write defensive code with retry logic/policies

## Connect to and consume Azure services and third-party services 15-20%

### Azure Logic Apps

- Azure Logic apps = automated workflows/orchestrations
- Azure Logic Apps is a service which allows to build workflows/work with tasks
    - Schedule
    - Automate
    - Control
    - Orchestrate
- Allows to visually built up the steps
- Includes multitude of built-in connectors
- Workflow control can include control flow logic - conditions (IF FAIL etc.), switch statements, loops and branching
- Workflows can be invoked via triggers (time, condition, event)
- Common triggers
    - When a message is received in a Service Bus queue
    - When a HTTP request is received
    - When a new tweet is posted
    - When an Event Grid resource event occurs
    - Recurrence
    - When a new email is received in Outlook.com
    - When a new file is created on OneDrive
    - When a file is added to FTP server
    - When a blob is added to storage account
- Create custom connectors - wrapper arround REST API endpoint
    1. Create and secure endpoint (Azure Functions, web app, API app)
    2. Define API (Open API, swagger)
    3. Add custom connector template
    4. Add custom connector to workflow
- Create templates

### Azure APIM

- APIM - service to create consistent and secure gateways for your API endpoints providing:
    - Security
    - Quotas
    - Caching
    - Diagnostics
- Used to control and manage traffic, more specifically to
    - Route traffic
    - Verify access
    - Enforce quotas and limits
    - Transform (stip out response headers, change response URLs)
    - Control caching
    - Improve logging (logging call metadata)
- Create a new APIM instance
- Configure authentication policies
    - Basic authentication - username and password
    - Client certificate - a certificate installed on the APIM instance
    - Managed identity - using services' built-in identities
- Configure policies
    - Rate limit - Rate-limited APIs will only handle a certain amount of calls in a certain amount of seconds
        - Rate-Limited <rate-limit calls="20" renewal-period="60" /> = 20 calls every minute per subscription
        - Renewal policy (renewal-period) is in seconds, and max value of it in rate policy is 300 seconds (5 mins)
        - Rate-Limited by key <rate-limit-by-kye calls="20" renewal-period="60" counter-key="@(context.Request.IpAddress)" />
    - Usage Quota = limit to a certain number of calls in a time period, can be scoped to subscription or to a key
        - Quota by key <quota-by-key calls="100" bandwidth="40000" renewal-period="3600" counter-key="@(context.Request.IpAddress" />
            - bandwidth in KB
            - renewal period in seconds, 3600 is a min value (60 min)
    - Rate or Quota
        - Renewal period more than 300 seconds (5 min) = Usage quota
        - Preven usage spikes = Rate limited


### Event-based solutions

- Producers publish events to a stream for receivers to subscribe to
    - Stream can have multiple subscribers
    - Producer has no control over subscribers
- Azure Event Grid
- Azure Event Hubs
- Azure Notifications Hubs

### Message-based systems

- Producers send messages to specific receivers
- Azure Service Bus
- Azure Storage Queues

### Automation Tools

- Command-line and SDK knowledge
    - Azure CLI
    - .NET SDK

- NO NEED to recognize exact syntax
- NEED to know outline and ordering